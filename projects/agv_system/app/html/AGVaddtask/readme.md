# AGV任务下发与查询系统

## 系统概述

AGV任务下发与查询系统是一个基于Web的自动化导引车任务管理平台，用于实现跨环境任务的查询、下发与优先级管理。系统提供了直观的用户界面，支持多种任务模板的快速下发，并具备智能的任务状态检查、实时查询和优先级调整功能。

## 主要功能

### 1. 任务下发
- 支持多种区域和任务模板选择
- 智能表单字段显示（根据任务类型动态显示货架号和任务路径字段）
- 一键下发任务到AGV系统
- 任务下发后自动执行任务查询

### 2. 任务状态检查
- **智能防重复下发**：在下发携带货架号的任务前，自动检查该货架是否存在以下状态的任务：
  - 4 - 正在发送
  - 6 - 执行中  
  - 9 - 已下发
- 如果存在相关任务，系统会弹窗提示用户，防止任务冲突

### 3. 任务查询功能
- **双模式查询**：
  - 按货架号查询：查询指定货架的相关任务
  - 按OrderId查询：通过订单ID精确查询任务
- **智能状态排序**：按货架查询时优先显示执行中任务，其次已下发，最后正在发送
- **子任务详情展示**：显示完整的子任务序列和执行状态

### 4. 优先级管理
- **优先执行功能**：为第一个子任务提供优先级调整
- **智能状态判断**：仅允许对"已下发"状态的任务调整优先级
- **防误操作保护**：已开始执行的任务无法调整优先级

### 5. 历史记录保护
- 5分钟内重复下发同一货架任务保护机制
- 自动记录货架任务下发时间

### 6. 用户界面特性
- **响应式设计**：支持桌面、平板、手机等不同设备访问
- **双栏布局**：左侧任务下发，右侧任务查询，操作流程清晰
- **明暗主题切换**：支持亮色和暗色主题，适应不同使用环境
- **实时调试信息**：可查看发送报文和响应信息
- **友好的交互反馈**：模态框提示、状态标签、防重复点击机制

## 系统配置

系统支持多个区域的配置，每个区域包含不同的任务模板：

### 已配置区域
- **A1-1 PCBA**：送满/回空/空车任务
- **A2-2 PCBA 货架区**：存储备料相关任务
- **A2-2 存储备料**：各类物料配送任务
- **A3-2 点胶 & 行业货架区2**：点胶区域搬运任务
- **A4-1 A4物流&A4包材**：物流包材运输任务

## 使用说明

### 任务下发流程

1. **选择区域**：从下拉菜单中选择任务执行区域
2. **选择任务模板**：根据业务需求选择具体的任务类型
3. **填写任务参数**：
   - 如需货架号：输入对应的货架编号
   - 如需任务路径：选择预设的路径选项
4. **下发任务**：点击"下发任务"按钮执行任务下发
5. **自动查询**：任务下发成功后自动跳转到查询界面显示任务状态

### 任务查询流程

1. **选择查询模式**：
   - 按货架查询：输入货架号查询相关任务
   - 按OrderId查询：输入订单ID精确查询
2. **执行查询**：点击"查询任务"按钮获取任务信息
3. **查看详情**：系统显示主任务信息和所有子任务详情
4. **管理优先级**：对第一个"已下发"状态的子任务点击"优先执行"

### 任务状态检查规则

- **需要检查的情况**：当任务配置中`requires_shelf`为`true`时（无论货架号变量是否为空，货架号验证已确保非空）
- **检查内容**：查询该货架在状态4、6、9、-1下是否存在任务
- **检查结果处理**：
  - 如果存在任务：弹窗提示，阻止下发，并自动在右侧查询界面显示该货架的任务信息
  - 如果不存在任务：正常下发
  - 如果查询失败：继续下发（容错处理）

### 查询状态优先级

按货架查询时，系统按以下优先级显示任务：
1. **执行中（状态6）** - 最高优先级
2. **已下发（状态9）** - 中等优先级  
3. **正在发送（状态4）** - 最低优先级

### 特殊说明

- **空车任务**：不需要货架号的任务直接下发，不进行状态检查
- **重复保护**：同一货架5分钟内只能下发一次任务
- **防重复点击**：查询和优先级按钮2秒内只能点击一次
- **实时反馈**：系统会显示任务下发的结果和详细信息

## 技术架构

### 前端技术
- HTML5 + CSS3 + 原生JavaScript
- 响应式网格布局设计
- CSS变量主题系统
- 本地存储主题偏好

### 接口对接

#### 任务下发接口
- **地址**：`http://10.68.2.32:7000/ics/taskOrder/addTask`
- **方法**：POST
- **内容**：JSON格式任务数据

#### 任务查询接口
- **大模板查询**：`http://10.68.2.32:8315/crossTask/query`
- **子任务查询**：`http://10.68.2.32:8315/crossTask/detail`
- **优先级调整**：`http://{serviceUrl}/ics/out/updateTaskPriority`

### 数据格式

#### 任务下发数据
```json
{
  "modelProcessCode": "任务代码",
  "priority": 6,
  "orderId": "订单ID",
  "fromSystem": "pad-html",
  "taskOrderDetail": {
    "taskPath": "任务路径",
    "shelfNumber": "货架号"
  }
}
```

#### 任务状态定义
- **8**：已完成
- **6**：执行中
- **4**：正在发送
- **9**：已下发
- **-1**：容量管控
- **0**：待处理

## 部署要求

### 环境要求
- 现代浏览器（Chrome 60+、Firefox 55+、Edge 79+等）
- 支持ES6+的JavaScript环境
- 网络访问权限（能够访问后端API服务）

### 部署步骤
1. 将HTML文件部署到Web服务器
2. 确保跨域访问权限配置正确
3. 验证后端API服务可用性
4. 测试各功能模块正常运行

## 维护信息

### 配置更新
系统配置内嵌在HTML文件中，如需更新区域或任务模板，需要修改`config`对象中的对应配置。

### 故障排查
- 查看浏览器控制台错误信息
- 使用调试模式查看发送报文和响应数据
- 检查网络连接和API服务状态
- 验证接口地址和参数格式

### 监控指标
- 任务下发成功率
- 查询响应时间
- 用户操作频率
- 系统错误率

## 版本信息

- **当前版本**：v1.4.2
- **更新日期**：2025年
- **新增功能**：任务查询、优先级管理、双栏界面
- **技术支持**：运营AGV组

## 更新日志

### 2026-01-09
- **版本**：更新系统版本号至v1.4.2
- **新增**：货架任务状态检查增加容量管控状态（-1）检测
  - 在`checkShelfTaskStatus`函数中添加状态-1检查
  - 当查询到状态为-1时，提示用户“此任务为容量管控”
  - 更新`getStatusText`函数支持状态-1显示
- **增强**：检查到货架存在任务时自动在右侧查询界面显示任务信息
  - 在`submitTask`函数中，当检查到货架存在任务时，自动填充货架查询输入框并触发查询
  - 用户可在右侧查询界面直接查看任务详情，无需手动查询

### 2026-01-07
- **修复**：上架任务货架任务状态检查逻辑
  - 原检查条件 `if (task.requires_shelf && shelf)` 可能因货架号变量为空而跳过检查
  - 修改为 `if (task.requires_shelf)`，确保所有需要货架号的任务都执行检查
  - 添加调试日志便于跟踪检查过程
  - 解决了上架任务在5分钟锁定过期后仍能重复下发的问题

## 注意事项

1. **数据准确性**：请确保货架号输入准确，避免任务下发错误
2. **操作规范**：系统会进行任务状态检查，请勿强行绕过检查机制
3. **权限控制**：优先执行功能仅对第一个子任务有效，防止误操作
4. **系统监控**：如遇系统异常，请及时联系技术支持人员
5. **配置维护**：定期检查系统配置，确保与现场业务流程匹配
6. **网络要求**：确保网络稳定，避免因网络问题导致操作失败

---

*本系统专为AGV任务管理设计，持续优化中。如有功能需求变更请联系开发团队。*