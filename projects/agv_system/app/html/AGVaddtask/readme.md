# AGV任务下发与查询系统

## 系统概述

AGV任务下发与查询系统是一个基于Web的自动化导引车任务管理平台，用于实现跨环境任务的查询、下发与优先级管理。系统提供了直观的用户界面，支持多种任务模板的快速下发，并具备智能的任务状态检查、实时查询和优先级调整功能。

## 主要功能

### 1. 任务下发
- 支持多种区域和任务模板选择
- 智能表单字段显示（根据任务类型动态显示货架号和任务路径字段）
- 一键下发任务到AGV系统
- 任务下发后自动执行任务查询

### 2. 任务状态检查
- **智能防重复下发**：在下发携带货架号的任务前，自动检查该货架是否存在以下状态的任务：
  - 4 - 正在发送
  - 6 - 执行中  
  - 9 - 已下发
- 如果存在相关任务，系统会弹窗提示用户，防止任务冲突

### 3. 任务查询功能
- **双模式查询**：
  - 按货架号查询：查询指定货架的相关任务
  - 按OrderId查询：通过订单ID精确查询任务
- **智能状态排序**：按货架查询时优先显示执行中任务，其次已下发，最后正在发送
- **子任务详情展示**：显示完整的子任务序列和执行状态

### 4. 优先级管理
- **优先执行功能**：为第一个子任务提供优先级调整
- **智能状态判断**：仅允许对"已下发"状态的任务调整优先级
- **防误操作保护**：已开始执行的任务无法调整优先级

### 5. 历史记录保护
- 5分钟内重复下发同一货架任务保护机制
- 自动记录货架任务下发时间

### 6. 用户界面特性
- **响应式设计**：支持桌面、平板、手机等不同设备访问
- **双栏布局**：左侧任务下发，右侧任务查询，操作流程清晰
- **明暗主题切换**：支持亮色和暗色主题，适应不同使用环境
- **实时调试信息**：可查看发送报文和响应信息
- **友好的交互反馈**：模态框提示、状态标签、防重复点击机制

## 系统配置

系统支持多个区域的配置，每个区域包含不同的任务模板：

### 已配置区域
- **A1-1 PCBA**：送满/回空/空车任务
- **A2-2 PCBA 货架区**：存储备料相关任务
- **A2-2 存储备料**：各类物料配送任务
- **A3-2 点胶 & 行业货架区2**：点胶区域搬运任务
- **A4-1 A4物流&A4包材**：物流包材运输任务

### 任务模板详情

以下表格列出了所有区域的任务模板配置：

| 区域 | 任务名称 | 任务代码 | 货架要求 | 路径要求 | 路径选项 |
|------|----------|----------|----------|----------|----------|
| A1-1 PCBA | 回空A1pcba1F去A2华昱欣3F | HJBY_31A1DZ1F_to_19A2HYX3F_back | 是 | 否 | 无 |
| | 空车A1pcba1F去A2华昱欣3F | K_31A1DZ1F_to_19A2HYX3F_go | 否 | 否 | 无 |
| | 空车A1pcba1F去A2华昱欣3F回 | K_31A1DZ1F_to_19A2HYX3F_leave | 否 | 否 | 无 |
| | 送满A1pcba1F去A2华昱欣3F | HJBY_31A1DZ1F_to_19A2HYX3F_go | 是 | 否 | 无 |
| A1-2 电装工厂 | 314空车A1电装2F去A2华消1F | K_31A1DZ1F_to_19A2HX1F_go | 否 | 否 | 无 |
| | 315空车A1pcba1F去A2华消2F回 | K_31A1DZ1F_to_19A2HX1F_leave | 否 | 否 | 无 |
| | 316送满A1电装2F去A2华消1F | HJBY_31A1DZ2F_to_19A2HX1F_go | 是 | 否 | 无 |
| | 317回空A1电装2F去A2华消1F | HJBY_31A1DZ2F_to_19A2HX1F_back | 是 | 否 | 无 |
| A2-2 PCBA 货架区 | 回空A1pcba1F去A2存储备料2F_296 | HJBY_31A1DZ1F_to_17A2CC2F_back | 是 | 否 | 无 |
| | 空车A1pcba1F去A2存储备料2F_293 | K_31A1DZ1F_to_17A2CC2F_go | 否 | 否 | 无 |
| | 空车A1pcba1F去A2存储备料2F回_294 | K_31A1DZ1F_to_17A2CC2F_leave | 否 | 否 | 无 |
| | 空车A2存储备料2F去A2华昱欣3F_297 | K_17A2CC2F_to_19A2HYX3F_go | 否 | 否 | 无 |
| | 空车A2存储备料2F去A2华昱欣3F回_298 | K_17A2CC2F_to_19A2HYX3F_leave | 否 | 否 | 无 |
| | 送满A1pcba1F去A2存储备料2F_295 | HJBY_31A1DZ1F_to_17A2CC2F_go | 是 | 否 | 无 |
| A2-2 存储备料 | B10座舱_送满A2存储备料去A2存储一部3F | xialiaoDA02-B10ZC | 是 | 否 | 无 |
| | NFC线_送满A2存储备料去A2存储一部3F | xialiaoDA02-NFCline | 是 | 否 | 无 |
| | TBOX_送满A2存储备料去A2存储一部3F | xialiaoDA02-TBOX | 是 | 否 | 无 |
| | 上架任务 | shangjiafangxia | 是 | 是 | 33254836 (（33254836）)<br>33254835 (（33254835）) |
| | 上架回库任务 | shangjiafangxiahk | 是 | 否 | 无 |
| | 右域控制器_送满A2存储备料去A2存储一部3F | xialiaoDA02-YYKZQ | 是 | 否 | 无 |
| | 回空A2备料2F去A2华消3FDT01 | HJBY_17A2BL2F_to_19A2HXZS1F_back | 是 | 否 | 无 |
| | 屏装线_送满A2存储备料去A2存储一部3F | xialiaoDA02-PZX | 是 | 否 | 无 |
| | 放大器_送满A2存储备料去A2存储一部3F | xialiaoDA02-FDQ | 是 | 否 | 无 |
| | 整车座椅_送满A2存储备料去A2存储一部3F | xialiaoDA02-ZCZY | 是 | 否 | 无 |
| | 老座舱_送满A2存储备料去A2存储一部3F | xialiaoDA02-LZC | 是 | 否 | 无 |
| A2-2 存储备料(NOC 跨环境上架调试) | 上架搬运_19新华消3F_to_172F_426 | SHJBY_19XHX3F_to_17XHX2F_426 | 是 | 是 | 60001260 (60001260) |
| | 上架搬运放下_19新华消3F_to_172F_427 | SJBYFX_19XHX3F_to_17XHX2F_427 | 是 | 是 | 60001260 (60001260) |
| | 下架搬运回库_19新华消3F_to_172F_428 | XJBYHK_19XHX3F_to_17XHX2F_428 | 是 | 否 | 无 |
| | 去空车_19新华消3F_to_172F_424 | K_go_19XHX3F_to_17XHX2F_424 | 否 | 否 | 无 |
| | 回空车_19新华消3F_to_172F_425 | K_back_19XHX3F_to_17XHX2F_425 | 否 | 否 | 无 |
| A2-3 华昱欣-CZ01-LH001 | 去空车<-_17华昱欣备料2F_to_19华昱欣3F_372 | kctoHYX | 否 | 否 | 无 |
| | 回空车->_17华昱欣备料2F_to_19华昱欣3F_373 | kctoHYX-back | 否 | 否 | 无 |
| | 大型下料任务流程370 | xialiaoCZ01-Large | 是 | 是 | 60001299 (行1列1)<br>60001298 (行2列1)<br>60001297 (行3列1)<br>60001249 (行2列2)<br>60001248 (行3列2) |
| | 大型下料回库流程371 | xialiaoCZ01Back-Large | 是 | 否 | 无 |
| A2-3 华昱欣←→A2-2原华橙车间 | 去空车<-_17华昱欣备料2F_to_19华昱欣3F_372 | kctoHYX | 否 | 否 | 无 |
| | 去空车<-_17原华橙车间2F_to_19华昱欣3F_417 | K_go_17YHCCJ2F_to_19HYX3F | 否 | 否 | 无 |
| | 回空->_17原华橙车间2F_to_19华昱欣3F_420 | HJBY_back17YHCCJ2F_to_19HYX3F | 是 | 否 | 无 |
| | 回空车->_17华昱欣备料2F_to_19华昱欣3F_373 | kctoHYX-back | 否 | 否 | 无 |
| | 回空车->_17原华橙车间2F_to_19华昱欣3F_418 | K_back_17YHCCJ2F_to_19HYX3F | 否 | 否 | 无 |
| | 送满<-_17原华橙车间2F_to_19华昱欣3F_419 | HJBY_go_17YHCCJ2F_to_19HYX3F | 是 | 否 | 无 |
| A2-3 华昱欣线体上架 ←→ A1-1月台 | 249空车A2备料2F去A2华消注塑工厂1F | K_17A2BL2F_to_19A2HXZS1F_go | 否 | 否 | 无 |
| | 250空车A2备料2F去A2华消注塑工厂1F回 | K_17A2BL2F_to_19A2HXZS1F_back | 否 | 否 | 无 |
| | 上架搬运_零跑物料配送跨环境A1-1上料华昱欣线体_431 | SHJBY_19XHX3F_to_36QCDZ1F_431 | 是 | 是 | 43000688 (43000688点一)<br>43000687 (43000687点二) |
| | 去空车_零跑物料配送跨环境A1-1上料华昱欣线体_429 | K_go_19XHX3F_to_36QCDZ1F_429 | 否 | 否 | 无 |
| | 回空车_零跑物料配送跨环境A1-1上料华昱欣线体_430 | K_back_19XHX3F_to_36QCDZ1F_430 | 否 | 否 | 无 |
| | 异常回库_零跑物料配送跨环境A1-1上料华昱欣线体_436 | HK_19XHX3F_to_36QCDZ1F_436 | 是 | 否 | 43000688 (43000688点一)<br>43000687 (43000687点二) |
| A2-3 存储备料&存储一部（调空车） | 269空车A2备料去A2存储一部3F | K_17CCBL2F_to_31A2CC1B3F_go | 否 | 否 | 无 |
| | 270空车A2备料去A2存储一部3F回 | K_17CCBL2F_to_31A2CC1B3F_back | 否 | 否 | 无 |
| A3-2 半成品备料部 | 下架搬运回库27半成品2F_to_31前端3F_423 | XJBYHK_27BCP2F_to_31QD3F | 是 | 是 | 22222591 (前端一部)<br>77882373 (前端二部)<br>99992246 (前端三部)<br>77882525 (前端四部) |
| | 去空车_27半成品2F_to_31前端3F_421 | K_go_27BCP2F_to_31QD3F | 否 | 否 | 无 |
| | 回空车_27半成品2F_to_31前端3F_422 | K_back_27BCP2F_to_31QD3F | 否 | 否 | 无 |
| A3-2 点胶 & 行业货架区2 | 上架搬运_行业货架区2去点胶回_407 | SJBY_HY2DJ2F_to_DJ2F | 是 | 是 | 66000358 (点胶区域) |
| | 去空车A3点胶2F去A3前端四部3F_320 | K_go_32A3DJ2F_to_31A3QD4B3F | 否 | 否 | 无 |
| | 回空A3货架区二2F去A3前端四部3F_409 | HJBY_back_27HY2DJ2F_to_31A3QD4B3F | 是 | 否 | 无 |
| | 回空车A3点胶2F去A3前端四部3F_321 | K_back_32A3DJ2F_to_31A3QD4B3F | 否 | 否 | 无 |
| | 回空车A3货架区二2F去A3点胶指定DJ_410 | K_back_27HY2DJ2F_to_31DJ | 否 | 否 | 无 |
| | 货架搬运DJXB1到一部收料区_439 | moveShelfToDJXB1ToDJXB2Q_439 | 是 | 否 | 无 |
| | 货架搬运DJXB1到三部收料区_441 | moveShelfToDJXB1ToDJthree_441 | 是 | 否 | 无 |
| | 货架搬运DJXB1到二部收料区_440 | moveShelfToDJXB1ToDJEBQ_440 | 是 | 否 | 无 |
| | 货架搬运DJXB1到四部收料区_442 | moveShelfToDJXB1ToDJQBQ_442 | 是 | 否 | 无 |
| | 送满A3货架区二2F去A3前端四部3F_408 | HJBY_go_27HY2DJ2F_to_31A3QD4B3F | 是 | 否 | 无 |
| A3-2 行业备料 & 行业货架区2 | 空车跨环境去货架区2_159 | HJQ2go | 否 | 否 | 无 |
| | 空车跨环境离货架区2_160 | HJQ2leave | 否 | 否 | 无 |
| A4-1 A4物流&A4包材 | 去空车A4物流1F去A4包材1F_414 | K_go_1A4WL2F_to_40A4BC1F | 否 | 否 | 无 |
| | 回空A4物流1F去A4包材1F_413 | HJBY_back_1A4WL2F_to_40A4BC1F | 是 | 否 | 无 |
| | 回空车A4物流1F去A4包材1F_415 | K_back_1A4WL2F_to_40A4BC1F | 否 | 否 | 无 |
| | 送满A4物流1F去A4包材1F_412 | HJBY_go_1A4WL2F_to_40A4BC1F | 是 | 是 | 60000374 (包材区域A)<br>60000373 (包材区域B)<br>60000372 (包材区域C) |


## 使用说明

### 任务下发流程

1. **选择区域**：从下拉菜单中选择任务执行区域
2. **选择任务模板**：根据业务需求选择具体的任务类型
3. **填写任务参数**：
   - 如需货架号：输入对应的货架编号
   - 如需任务路径：选择预设的路径选项
4. **下发任务**：点击"下发任务"按钮执行任务下发
5. **自动查询**：任务下发成功后自动跳转到查询界面显示任务状态

### 任务查询流程

1. **选择查询模式**：
   - 按货架查询：输入货架号查询相关任务
   - 按OrderId查询：输入订单ID精确查询
2. **执行查询**：点击"查询任务"按钮获取任务信息
3. **查看详情**：系统显示主任务信息和所有子任务详情
4. **管理优先级**：对第一个"已下发"状态的子任务点击"优先执行"

### 任务状态检查规则

- **需要检查的情况**：当任务配置中`requires_shelf`为`true`且用户输入了货架号时
- **检查内容**：查询该货架在状态4、6、9下是否存在任务
- **检查结果处理**：
  - 如果存在任务：弹窗提示，阻止下发
  - 如果不存在任务：正常下发
  - 如果查询失败：继续下发（容错处理）

### 查询状态优先级

按货架查询时，系统按以下优先级显示任务：
1. **执行中（状态6）** - 最高优先级
2. **已下发（状态9）** - 中等优先级  
3. **正在发送（状态4）** - 最低优先级

### 特殊说明

- **空车任务**：不需要货架号的任务直接下发，不进行状态检查
- **重复保护**：同一货架5分钟内只能下发一次任务
- **防重复点击**：查询和优先级按钮2秒内只能点击一次
- **实时反馈**：系统会显示任务下发的结果和详细信息

## 技术架构

### 前端技术
- HTML5 + CSS3 + 原生JavaScript
- 响应式网格布局设计
- CSS变量主题系统
- 本地存储主题偏好

### 接口对接

#### 任务下发接口
- **地址**：`http://10.68.2.32:7000/ics/taskOrder/addTask`
- **方法**：POST
- **内容**：JSON格式任务数据

#### 任务查询接口
- **大模板查询**：`http://10.68.2.32:8315/crossTask/query`
- **子任务查询**：`http://10.68.2.32:8315/crossTask/detail`
- **优先级调整**：`http://{serviceUrl}/ics/out/updateTaskPriority`

### 数据格式

#### 任务下发数据
```json
{
  "modelProcessCode": "任务代码",
  "priority": 6,
  "orderId": "订单ID",
  "fromSystem": "pad-html",
  "taskOrderDetail": {
    "taskPath": "任务路径",
    "shelfNumber": "货架号"
  }
}
```

#### 任务状态定义
- **8**：已完成
- **6**：执行中
- **4**：正在发送
- **9**：已下发
- **0**：待处理

## 部署要求

### 环境要求
- 现代浏览器（Chrome 60+、Firefox 55+、Edge 79+等）
- 支持ES6+的JavaScript环境
- 网络访问权限（能够访问后端API服务）

### 部署步骤
1. 将HTML文件部署到Web服务器
2. 确保跨域访问权限配置正确
3. 验证后端API服务可用性
4. 测试各功能模块正常运行

## 维护信息

### 配置更新
系统配置内嵌在HTML文件中，如需更新区域或任务模板，需要修改`config`对象中的对应配置。

### 故障排查
- 查看浏览器控制台错误信息
- 使用调试模式查看发送报文和响应数据
- 检查网络连接和API服务状态
- 验证接口地址和参数格式

### 监控指标
- 任务下发成功率
- 查询响应时间
- 用户操作频率
- 系统错误率

## 版本信息

- **当前版本**：v2.0
- **更新日期**：2025年
- **新增功能**：任务查询、优先级管理、双栏界面
- **技术支持**：运营AGV组

## 注意事项

1. **数据准确性**：请确保货架号输入准确，避免任务下发错误
2. **操作规范**：系统会进行任务状态检查，请勿强行绕过检查机制
3. **权限控制**：优先执行功能仅对第一个子任务有效，防止误操作
4. **系统监控**：如遇系统异常，请及时联系技术支持人员
5. **配置维护**：定期检查系统配置，确保与现场业务流程匹配
6. **网络要求**：确保网络稳定，避免因网络问题导致操作失败

---

*本系统专为AGV任务管理设计，持续优化中。如有功能需求变更请联系开发团队。*